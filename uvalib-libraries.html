<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../uvalib-api/uvalib-api.html">

<!--
Element providing an easy component access to the uva Library's branches and units.

##### Example

    <uvalib-libraries></uvalib-libraries>

@element uvalib-libraries
@blurb lement providing an easy component access to the uva Library's branches and units.
@status alpha
@homepage http://uvalib-components.github.io/uvalib-libraries
-->
<polymer-element name="uvalib-libraries" attributes="auto libraries library">
  <template>
    <uvalib-api on-uvalib-api-load="{{apiLoaded}}"></uvalib-api>
  </template>
  <script>
    Polymer({

      observe: {
        auto: 'fetch',
        library: 'fetch'
      },

      /**
       * The `auto` attribute set to true means that the libraries will be queried 
       * whenever a request attribute is changed.
       *
       * @attribute auto
       * @type bool
       * @default false
       */
      auto: false,

      /**
       * The `libraries` attribute is set with the results for a libraries request
       *
       * @attribute libraries
       * @type array
       * @default null
       */
      libraries: null,

      /**
       * The `library` attribute specifies the library to return a listing for
       *
       * @attribute library
       * @type string
       * @default null
       */ 
      library: null,

      /**
       * The `api` property is set to the Library's client catalog api once loaded
       *
       * @attribute api
       * @type object
       * @default null
       */
      api: null,

      apiLoaded: function (e) {
        this.api = e.detail.library;
        if (this.auto)
          this.fetch();
      },

      // Keep track of requests so that older ones can be ignored
      // ToDo: see if we can cancel api requests before they return
      requests:[],

      /**
       * The `fetch` method will make a query request against the catalog.
       *
       * @method fetch
       */
      fetch: function () {
        if (this.api) {

          // Cancel all requests currently running
          for (var i=0; i<this.requests.length; i++)
            this.requests[i].cancel=true;

          var req_pack = {};

          // Put a simple message into the requests queue for this request
          var mess = {cancel:false};
          this.requests.push(mess);

          this.api.list(req_pack).execute( this.parseResults.bind(this, mess) );
          console.log('fetching library results!');
        }
      },

      /**
       * The `uvalib-libraries-fetched-results` event is fired whenever we
       * call fetch and process the results.
       *
       * @event uvalib-libraries-fetched-results
       */
      parseResults: function(mess, results){
        if (!mess.cancel) {
          this.libraries = results.libraries;          
          this.fire('uvalib-libraries-fetched-results');
        } else {
          console.log('fetch canceled!');
        }

        // remove this requests message from the queue
        for (var i=0; i<this.requests.length; i++)
          if (mess == this.requests[i]) {
            this.requests.splice(i,1);
            break;
          }
      }
      
    });
  </script>
</polymer-element>